<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <h2>these are the recommendations from your library</h2>
    <span class="name1-1" style="display: flex; align-items: start;"></span>
    <span class="genre1-1" style="display: flex; align-items: start;"></span>
    <span class="image1-1"></span>
    <span class="url1-1"></span>

    <span class="name1-2" style="display: flex; align-items: start;"></span>
    <span class="genre1-2" style="display: flex; align-items: start;"></span>
    <span class="image1-2"></span>
    <span class="url1-2"></span>

    <span class="name1-3" style="display: flex; align-items: start;"></span>
    <span class="genre1-3" style="display: flex; align-items: start;"></span>
    <span class="image1-3"></span>
    <span class="url1-3"></span>
    <h2>You can also get recommendations from a random artist</h2>

    <form action="" id="submitID">
        <input type="text" id="artistID" placeholder="artist's spotify page url">
        <input type="submit">
    </form>

    <span class="name" style="display: flex; align-items: start;"></span>
    <span class="genre" style="display: flex; align-items: start;"></span>
    <span class="image"></span>


    <script>
        const urlParams = new URLSearchParams(window.location.search);
        let code = urlParams.get('code');

        const clientId = '5d2c26f8146946acadf06485d7600ce7';
        const redirectUri = 'http://localhost:5500/redirect.html';

        let codeVerifier = localStorage.getItem('code_verifier');

        let body = new URLSearchParams({
            grant_type: 'authorization_code',
            code: code,
            redirect_uri: redirectUri,
            client_id: clientId,
            code_verifier: codeVerifier
        });

        const response = fetch('https://accounts.spotify.com/api/token', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: body
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('HTTP status ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                localStorage.setItem('access_token', data.access_token);
                getProfile();
            })
            .catch(error => {
                console.error('Error:', error);
            });
            
        async function showArtistData(e) {
            e.preventDefault();
            let separateID = document.getElementById("artistID").value.split("/");
            let artistID = separateID[5];
            let accessToken = localStorage.getItem('access_token');
            let response2 = await fetch(`https://api.spotify.com/v1/artists/${artistID}`, {
                headers: {
                    Authorization: 'Bearer ' + accessToken
                }
            })
            
            const data2 = await response2.json();
            console.log(data2);
            document.getElementsByClassName("name")[0].innerHTML = "name: " + data2.name;
            document.getElementsByClassName("genre")[0].innerHTML = "genres: " + data2.genres;
            document.getElementsByClassName("image")[0].innerHTML = `<image src = ${data2.images[1].url}>`;
                
            };
            showArtistData();
            document.getElementById("submitID").addEventListener("submit", showArtistData);

        async function getProfile() {
            let accessToken = localStorage.getItem('access_token');

            //const response = await fetch('https://api.spotify.com/v1/me', {
            //const response = await fetch('https://api.spotify.com/v1/me/tracks/contains?ids=7ouMYWpwJ422jRcDASZB7P%2C4VqPOruhp5EdPBeR92t6lQ%2C2takcwOaAZWiXQijPHIx7B', {
            const response = await fetch('https://api.spotify.com/v1/me/tracks', {
                //const response = await fetch('https://api.spotify.com/v1/recommendations?seed_artists=3TVXtAsR1Inumwj472S9r4&seed_genres=canadian_hip_hop', {
                //const response = await fetch('https://api.spotify.com/v1/artists/0TnOYISbd1XYRBk9myaseg', {
                headers: {
                    Authorization: 'Bearer ' + accessToken
                }
            });

            const data = await response.json();
            console.log(data);
            showRecomendation(data);
        }



        async function showRecomendation(data) {
            let recomendationURL = "https://api.spotify.com/v1/recommendations?"
            let artistID = data.items[0].track.artists[0].id;
            recomendationURL += "seed_artists=" + artistID;
            //console.log(recomendationURL);

            let accessToken = localStorage.getItem('access_token');

            const response3 = await fetch(recomendationURL, {
                headers: {
                    Authorization: 'Bearer ' + accessToken
                }
            });
            const data3 = await response3.json();

            document.getElementsByClassName("name1-1")[0].innerHTML = "artist: " + data3.tracks[0].artists[0].name;
            document.getElementsByClassName("genre1-1")[0].innerHTML = "song: " + data3.tracks[0].name;
            document.getElementsByClassName("image1-1")[0].innerHTML = `<image src = ${data3.tracks[0].album.images[1].url}>`;
            document.getElementsByClassName("url1-1")[0].innerHTML = `<a href = ${data3.tracks[0].external_urls.spotify}>click to listen</a>`;
            console.log(data3.tracks[0].external_urls.spotify)
            
            
            document.getElementsByClassName("name1-2")[0].innerHTML = "artist: " + data3.tracks[1].artists[0].name;
            document.getElementsByClassName("genre1-2")[0].innerHTML = "song: " + data3.tracks[1].name;
            document.getElementsByClassName("image1-2")[0].innerHTML = `<image src = ${data3.tracks[1].album.images[1].url}>`;
            document.getElementsByClassName("url1-2")[0].innerHTML = `<a href = ${data3.tracks[1].external_urls.spotify}>click to listen</a>`;
            
            
            document.getElementsByClassName("name1-3")[0].innerHTML = "artist: " + data3.tracks[2].artists[0].name;
            document.getElementsByClassName("genre1-3")[0].innerHTML = "song: " + data3.tracks[2].name;
            document.getElementsByClassName("image1-3")[0].innerHTML = `<image src = ${data3.tracks[2].album.images[1].url}>`;
            document.getElementsByClassName("url1-3")[0].innerHTML = `<a href = ${data3.tracks[2].external_urls.spotify}>click to listen</a>`;

            // genresのspaceは_で置き換えないといけない
            // click to listenな感じにしたい
        }

        // function makeItUsable(genres) {
        //     if (genres.includes(" ")) {
        //         genres.replace(" ", "_")
        //     } else {
        //         genres;
        //     }
        //     return genres;
        // }




    // https://api.spotify.com/v1/recommendations?seed_artists=4NHQUGzhtTLFvgF5SZesLK&seed_genres=classical%2Ccountry&seed_tracks=0c6xIDDpzE81m2q797ordA
    // .then(
    //     document.getElementsByClassName("name").innerHTML = data2.name
    // );

    //drakeのページ　https://open.spotify.com/intl-ja/artist/3TVXtAsR1Inumwj472S9r4
    //ゆるふわ　https://open.spotify.com/intl-ja/artist/5F80x2l9juqR6RLeuACpqS
    //track url https://open.spotify.com/intl-ja/track/1ogsoWs0VHSgveJY86xW4Z?si=0a788af5a49d40da
    </script>


</body>

</html>